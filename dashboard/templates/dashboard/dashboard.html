{% extends 'base.html' %}
{% load static %}

{% block content %}
<h1 class="text-3xl font-bold mb-6">Vendor Management Dashboard</h1>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Total Vendors</h2>
        <p class="text-3xl">{{ total_vendors }}</p>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Total Spend</h2>
        <p class="text-3xl" id="total-spend">{{ total_spend }}</p>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Avg Risk Score</h2>
        <p class="text-3xl">{{ avg_risk_score|floatformat:2 }}</p>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">High Risk Vendors</h2>
        <p class="text-3xl" id="high-risk-vendors">Loading...</p>
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Risk Distribution</h2>
        <canvas id="risk-chart"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Spend by Year</h2>
        <canvas id="spend-chart"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Spend by Relationship Type</h2>
        <canvas id="relationship-chart"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Contract Type Distribution</h2>
        <canvas id="contract-chart"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Geographical Distribution</h2>
        <canvas id="geo-chart"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow">
        <h2 class="text-lg font-semibold mb-2">Vendor Performance</h2>
        <p>Average Rating: <span id="avg-rating">Loading...</span></p>
        <p>Average Discount: <span id="avg-discount">Loading...</span></p>
    </div>
</div>

<div class="bg-white p-4 rounded shadow mb-8">
    <h2 class="text-lg font-semibold mb-2">Recent Activity</h2>
    <ul>
        {% for activity in recent_activities %}
        <li>{{ activity.date|date:"Y-m-d H:i" }} - {{ activity.action }} - {{ activity.details }}</li>
        {% endfor %}
    </ul>
</div>

<button id="export-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
    Export Dashboard Data
</button>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/dashboard-data/')
            .then(response => response.json())
            .then(data => {
                updateDashboard(data);
            });

        function updateDashboard(data) {
            console.log('Received dashboard data:', data);

            function updateElement(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.error(`Element with id '${id}' not found`);
                }
            }

            function createChart(canvasId, type, data, labelKey, valueKey) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error(`Canvas with id '${canvasId}' not found`);
                    return;
                }

                new Chart(canvas, {
                    type: type,
                    data: {
                        labels: data.map(item => item[labelKey]),
                        datasets: [{
                            data: data.map(item => item[valueKey]),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                            ],
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: canvasId.replace('-', ' ').toUpperCase()
                            }
                        }
                    }
                });
            }

            updateElement('high-risk-vendors', data.high_risk_vendors);
            updateElement('total-spend', data.total_spend);

            if (data.vendor_performance) {
                updateElement('avg-rating', parseFloat(data.vendor_performance.avg_rating).toFixed(2));
                updateElement('avg-discount', parseFloat(data.vendor_performance.avg_discount).toFixed(2) + '%');
            } else {
                console.error('Vendor performance data is missing');
            }

            createChart('risk-chart', 'pie', data.risk_distribution, 'risk_level', 'count');
            createChart('spend-chart', 'line', data.spend_by_year, 'year', 'total_spend');
            createChart('relationship-chart', 'bar', data.spend_by_relationship, 'relationship_type', 'total_spend');
            createChart('contract-chart', 'pie', data.contract_distribution, 'contract_type', 'count');

            const topCountries = data.geographical_distribution
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            createChart('geo-chart', 'bar', topCountries, 'country', 'count');

            console.log('Dashboard update completed');
        }

        document.getElementById('export-btn').addEventListener('click', function () {
            fetch('/api/dashboard-data/')
                .then(response => response.json())
                .then(data => {
                    let csv = 'data:text/csv;charset=utf-8,';
                    csv += 'Category,Subcategory,Value\n';

                    for (let key in data) {
                        if (Array.isArray(data[key])) {
                            data[key].forEach(item => {
                                csv += `${key},${Object.values(item).join(',')}\n`;
                            });
                        } else if (typeof data[key] === 'object') {
                            for (let subKey in data[key]) {
                                csv += `${key},${subKey},${data[key][subKey]}\n`;
                            }
                        } else {
                            csv += `${key},,${data[key]}\n`;
                        }
                    }

                    var encodedUri = encodeURI(csv);
                    var link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "dashboard_data.csv");
                    document.body.appendChild(link);
                    link.click();
                });
        });
    });
</script>
{% endblock %}